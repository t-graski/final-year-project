<div class="view-container">
  <div class="view-header">
    <h2>Modules Management</h2>
    <div class="view-actions">
      <div class="form-group-inline">
        <label for="course-filter">Course:</label>
        <select id="course-filter" [(ngModel)]="selectedCourseId" (change)="loadModules()"
                class="form-control-inline">
          <option value="">-- Select Course --</option>
          @for (course of courses(); track course.id) {
            <option [value]="course.id">{{ course.courseCode }} - {{ course.title }}</option>
          }
        </select>
      </div>
      <button *appHasPermission="Permission.CatalogWrite"
              class="action-btn-toolbar action-btn-toolbar--primary"
              (click)="openCreateModuleModal()" title="Add new module"
              [disabled]="!selectedCourseId()">
        <mat-icon fontIcon="add"></mat-icon>
        <span>Add Module</span>
      </button>
    </div>
  </div>

  <app-dynamic-table
    [$data]="modules()"
    [$columns]="moduleColumns"
    [$actions]="moduleActions"
    [$loading]="isLoading()"
    $searchPlaceholder="Search modules by code or title..."
    $emptyMessage="No modules found"
    ($reload)="reloadModules()"
  ></app-dynamic-table>
</div>

@if (showModuleDetails()) {
  <div class="modal-overlay" (click)="closeModuleDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Module Details</h3>
        <button class="modal-close" (click)="closeModuleDetails()">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </div>

      <div class="modal-body">
        @for (module of modules(); track module.id) {
          @if (module.id === showModuleDetails()) {
            <div class="detail-row">
              <span class="detail-label">Module ID:</span>
              <span class="detail-value">{{ module.id }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Module Code:</span>
              <span class="detail-value">{{ module.moduleCode }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Title:</span>
              <span class="detail-value">{{ module.title }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Description:</span>
              <span class="detail-value">{{ module.description || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Credits:</span>
              <span class="detail-value">{{ module.credits || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Level:</span>
              <span class="detail-value">{{ module.level || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Semester:</span>
              <span class="detail-value">{{ module.semesterOfStudy || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Term:</span>
              <span class="detail-value">{{ module.term || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Course ID:</span>
              <span class="detail-value">{{ module.courseId }}</span>
            </div>
          }
        }
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModuleDetails()">Close</button>
      </div>
    </div>
  </div>
}

@if (showCreateModuleModal()) {
  <div class="modal-overlay" (click)="closeCreateModuleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Create New Module</h3>
        <button class="modal-close" (click)="closeCreateModuleModal()">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label for="module-code">Module Code *</label>
          <input
            type="text"
            id="module-code"
            [(ngModel)]="newModule().code"
            placeholder="e.g., CS201">
        </div>

        <div class="form-group">
          <label for="module-title">Title *</label>
          <input
            type="text"
            id="module-title"
            [(ngModel)]="newModule().title"
            placeholder="Enter module title">
        </div>

        <div class="form-group">
          <label for="module-description">Description</label>
          <textarea
            id="module-description"
            [(ngModel)]="newModule().description"
            placeholder="Enter module description"></textarea>
        </div>

        <div class="form-group">
          <label for="module-credits">Credits</label>
          <input
            type="number"
            id="module-credits"
            [(ngModel)]="newModule().credits"
            min="0"
            placeholder="e.g., 15">
        </div>

        <div class="form-group">
          <label for="module-level">Level</label>
          <input
            type="number"
            id="module-level"
            [(ngModel)]="newModule().level"
            min="0"
            placeholder="e.g., 4">
        </div>

        <div class="form-group">
          <label for="module-semester">Semester of Study</label>
          <input
            type="number"
            id="module-semester"
            [(ngModel)]="newModule().semesterOfStudy"
            min="1"
            placeholder="e.g., 1">
        </div>

        <div class="form-group">
          <label for="module-term">Term</label>
          <input
            type="text"
            id="module-term"
            [(ngModel)]="newModule().term"
            placeholder="e.g., Autumn">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeCreateModuleModal()">Cancel</button>
        <button class="btn-primary" (click)="createModule()">
          <mat-icon fontIcon="add"></mat-icon>
          Create Module
        </button>
      </div>
    </div>
  </div>
}
