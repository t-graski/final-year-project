<div class="admin-dashboard" (click)="closeAllContextMenus()">
  <app-navbar
    [title]="'Admin Dashboard'"
    [subTitle]="'System Administration'"
    [userName]="getCurrentUserName()"
    [userEmail]="getCurrentUserEmail()"
    [links]="[
      { label: 'Dashboard', path: '/dashboard', icon: 'dashboard' },
      { label: 'Users', path: '/admin', icon: 'people' }
    ]">
  </app-navbar>

  <div class="admin-container">
    <aside class="sidebar">
      <h3>Settings</h3>
      <nav class="sidebar-nav">
        <button
          class="sidebar-item"
          [class.sidebar-item--active]="currentView() === 'users'"
          (click)="setView('users')">
          <mat-icon fontIcon="people"></mat-icon>
          <span>Users</span>
        </button>
        <button
          class="sidebar-item"
          [class.sidebar-item--active]="currentView() === 'courses'"
          (click)="setView('courses')">
          <mat-icon fontIcon="school"></mat-icon>
          <span>Courses</span>
        </button>
        <button
          class="sidebar-item"
          [class.sidebar-item--active]="currentView() === 'modules'"
          (click)="setView('modules')">
          <mat-icon fontIcon="menu_book"></mat-icon>
          <span>Modules</span>
        </button>

        <div class="sidebar-divider"></div>

        <button
          class="sidebar-item"
          [class.sidebar-item--active]="currentView() === 'enroll-course'"
          (click)="setView('enroll-course')">
          <mat-icon fontIcon="person_add"></mat-icon>
          <span>Enroll in Course</span>
        </button>
        <button
          class="sidebar-item"
          [class.sidebar-item--active]="currentView() === 'enroll-module'"
          (click)="setView('enroll-module')">
          <mat-icon fontIcon="playlist_add"></mat-icon>
          <span>Enroll in Module</span>
        </button>

        <div class="sidebar-divider"></div>

        <button
          class="sidebar-item"
          [class.sidebar-item--active]="currentView() === 'audit'"
          (click)="setView('audit')">
          <mat-icon fontIcon="history"></mat-icon>
          <span>Audit Log</span>
        </button>
      </nav>
    </aside>

    <main class="content">
      @if (isLoading()) {
        <div class="loading">
          <p>Loading...</p>
        </div>
      } @else {
        @if (currentView() === 'users') {
          <div class="view-container">
            <div class="view-header">
              <h2>Users Management</h2>
              <button class="action-btn-toolbar action-btn-toolbar--primary"
                      (click)="openCreateUserModal()" title="Add new user">
                <mat-icon fontIcon="add"></mat-icon>
                <span>Add User</span>
              </button>
            </div>

            <app-dynamic-table
              [data]="users()"
              [columns]="userColumns"
              [actions]="userActions"
              [loading]="isLoading()"
              searchPlaceholder="Search users by name, email, or role..."
              emptyMessage="No users found"
              (reload)="reloadUsers()"
            ></app-dynamic-table>
          </div>
        }

        @if (currentView() === 'courses') {
          <div class="view-container">
            <div class="view-header">
              <h2>Courses Management</h2>
              <button class="action-btn-toolbar action-btn-toolbar--primary"
                      (click)="openCreateCourseModal()" title="Add new course">
                <mat-icon fontIcon="add"></mat-icon>
                <span>Add Course</span>
              </button>
            </div>

            <app-dynamic-table
              [data]="courses()"
              [columns]="courseColumns"
              [actions]="courseActions"
              [loading]="isLoading()"
              searchPlaceholder="Search courses by code or title..."
              emptyMessage="No courses found"
              (reload)="reloadCourses()"
            ></app-dynamic-table>
          </div>
        }

        @if (currentView() === 'modules') {
          <div class="view-container">
            <div class="view-header">
              <h2>Modules Management</h2>
              <div class="view-actions">
                <div class="form-group-inline">
                  <label for="course-filter">Course:</label>
                  <select id="course-filter" [(ngModel)]="selectedCourseId" (change)="loadModules()"
                          class="form-control-inline">
                    <option value="">-- Select Course --</option>
                    @for (course of courses(); track course.id) {
                      <option [value]="course.id">{{ course.courseCode }}- {{ course.title }}
                      </option>
                    }
                  </select>
                </div>
                <button class="action-btn-toolbar action-btn-toolbar--primary"
                        (click)="openCreateModuleModal()" title="Add new module"
                        [disabled]="!selectedCourseId()">
                  <mat-icon fontIcon="add"></mat-icon>
                  <span>Add Module</span>
                </button>
              </div>
            </div>

            <app-dynamic-table
              [data]="modules()"
              [columns]="moduleColumns"
              [actions]="moduleActions"
              [loading]="isLoading()"
              searchPlaceholder="Search modules by code or title..."
              emptyMessage="No modules found"
              (reload)="reloadModules()"
            ></app-dynamic-table>
          </div>
        }

        @if (currentView() === 'enroll-course') {
          <div class="view-container">
            <div class="view-header">
              <h2>Enroll Students in Course</h2>
            </div>

            @if (isLoadingEnrollmentData()) {
              <div class="loading-overlay">
                <div class="loading-spinner">
                  <mat-icon fontIcon="hourglass_empty" class="spinning"></mat-icon>
                  <p>Loading student enrollment data...</p>
                </div>
              </div>
            }

            <div class="enrollment-container" [class.disabled]="isLoadingEnrollmentData()">
              <div class="enrollment-section">
                <h3>Select Students</h3>
                <div class="search-bar">
                  <mat-icon fontIcon="search"></mat-icon>
                  <input
                    type="text"
                    placeholder="Search students by name or email..."
                    [(ngModel)]="studentSearchQuery"
                    class="search-input"
                    [disabled]="isLoadingEnrollmentData() || isLoading()"
                  />
                </div>

                @if (isLoading()) {
                  <div class="section-loading">
                    <mat-icon fontIcon="refresh" class="spinning"></mat-icon>
                    <p>Loading students...</p>
                  </div>
                } @else {
                  <div class="student-list">
                    @for (user of getFilteredStudents(); track user.id) {
                      <label class="student-item"
                             [class.student-item--selected]="isStudentSelected(user.id!)">
                        <input
                          type="checkbox"
                          [checked]="isStudentSelected(user.id!)"
                          (change)="toggleStudentSelection(user.id!)"
                          [disabled]="isLoadingEnrollmentData()"
                        />
                        <div class="student-info">
                          <span class="student-name">{{ user.firstName }} {{ user.lastName }}</span>
                          <span class="student-email">{{ user.email }}</span>
                        </div>
                      </label>
                    } @empty {
                      <div class="empty-state">
                        <mat-icon fontIcon="person_off"></mat-icon>
                        <p>No students found</p>
                      </div>
                    }
                  </div>

                  <div class="selection-summary">
                    {{ getSelectedStudentIds().length }} student(s) selected
                  </div>
                }
              </div>

              <div class="enrollment-section">
                <h3>Select Course</h3>
                <div class="search-bar">
                  <mat-icon fontIcon="search"></mat-icon>
                  <input
                    type="text"
                    placeholder="Search courses by code or title..."
                    [(ngModel)]="courseSearchQuery"
                    class="search-input"
                    [disabled]="isLoadingEnrollmentData() || isLoading()"
                  />
                </div>

                @if (isLoading()) {
                  <div class="section-loading">
                    <mat-icon fontIcon="refresh" class="spinning"></mat-icon>
                    <p>Loading courses...</p>
                  </div>
                } @else {
                  <div class="course-list">
                    @for (course of getFilteredCourses(); track course.id) {
                      <div
                        class="course-item"
                        [class.course-item--selected]="selectedCourseId() === course.id"
                        [class.disabled]="isLoadingEnrollmentData()"
                        (click)="!isLoadingEnrollmentData() && selectCourseForEnrollment(course.id!)"
                      >
                        <div class="course-code">{{ course.courseCode }}</div>
                        <div class="course-title">{{ course.title }}</div>
                      </div>
                    } @empty {
                      <div class="empty-state">
                        <mat-icon fontIcon="school"></mat-icon>
                        <p>No courses found</p>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>

            <div class="enrollment-actions">
              <button
                class="btn-primary btn-large"
                (click)="enrollStudentsInCourse()"
                [disabled]="!canEnrollInCourse() || isLoadingEnrollmentData()"
              >
                <mat-icon fontIcon="person_add"></mat-icon>
                Enroll {{ getSelectedStudentIds().length }} Student(s) in Course
              </button>
            </div>
          </div>
        }

        @if (currentView() === 'enroll-module') {
          <div class="view-container">
            <div class="view-header">
              <h2>Enroll Students in Module</h2>
            </div>

            @if (isLoadingEnrollmentData()) {
              <div class="loading-overlay">
                <div class="loading-spinner">
                  <mat-icon fontIcon="hourglass_empty" class="spinning"></mat-icon>
                  <p>Loading student enrollment data...</p>
                </div>
              </div>
            }

            <div class="enrollment-container" [class.disabled]="isLoadingEnrollmentData()">
              <div class="enrollment-section">
                <h3>Select Students</h3>
                <div class="search-bar">
                  <mat-icon fontIcon="search"></mat-icon>
                  <input
                    type="text"
                    placeholder="Search students by name or email..."
                    [(ngModel)]="studentSearchQuery"
                    class="search-input"
                    [disabled]="isLoadingEnrollmentData() || isLoading()"
                  />
                </div>

                @if (isLoading()) {
                  <div class="section-loading">
                    <mat-icon fontIcon="refresh" class="spinning"></mat-icon>
                    <p>Loading students...</p>
                  </div>
                } @else {
                  <div class="student-list">
                    @for (user of getFilteredStudents(); track user.id) {
                      <label class="student-item"
                             [class.student-item--selected]="isStudentSelected(user.id!)">
                        <input
                          type="checkbox"
                          [checked]="isStudentSelected(user.id!)"
                          (change)="toggleStudentSelection(user.id!)"
                          [disabled]="isLoadingEnrollmentData()"
                        />
                        <div class="student-info">
                          <span class="student-name">{{ user.firstName }} {{ user.lastName }}</span>
                          <span class="student-email">{{ user.email }}</span>
                        </div>
                      </label>
                    } @empty {
                      <div class="empty-state">
                        <mat-icon fontIcon="person_off"></mat-icon>
                        <p>No students found</p>
                      </div>
                    }
                  </div>

                  <div class="selection-summary">
                    {{ getSelectedStudentIds().length }} student(s) selected
                  </div>
                }
              </div>

              <div class="enrollment-section">
                <h3>Select Module</h3>

                @if (isLoading()) {
                  <div class="section-loading">
                    <mat-icon fontIcon="refresh" class="spinning"></mat-icon>
                    <p>Loading courses...</p>
                  </div>
                } @else {
                  <div class="form-group">
                    <label for="course-filter-module">Course:</label>
                    <select id="course-filter-module" [(ngModel)]="selectedCourseId"
                            (change)="loadModules()" class="form-control-inline"
                            [disabled]="isLoadingEnrollmentData()">
                      <option value="">-- Select Course --</option>
                      @for (course of courses(); track course.id) {
                        <option [value]="course.id">{{ course.courseCode }}- {{ course.title }}
                        </option>
                      }
                    </select>
                  </div>
                }

                <div class="search-bar">
                  <mat-icon fontIcon="search"></mat-icon>
                  <input
                    type="text"
                    placeholder="Search modules by code or title..."
                    [(ngModel)]="moduleSearchQuery"
                    class="search-input"
                    [disabled]="isLoadingEnrollmentData()"
                  />
                </div>

                <div class="module-list">
                  @for (module of getFilteredModules(); track module.id) {
                    <div
                      class="module-item"
                      [class.module-item--selected]="selectedModuleId() === module.id"
                      [class.disabled]="isLoadingEnrollmentData()"
                      (click)="!isLoadingEnrollmentData() && selectModuleForEnrollment(module.id!)"
                    >
                      <div class="module-code">{{ module.moduleCode }}</div>
                      <div class="module-title">{{ module.title }}</div>
                    </div>
                  } @empty {
                    <div class="empty-state">
                      <mat-icon fontIcon="menu_book"></mat-icon>
                      <p>{{ selectedCourseId() ? 'No modules found' : 'Please select a course first' }}</p>
                    </div>
                  }
                </div>
              </div>
            </div>

            <div class="enrollment-actions">
              <button
                class="btn-primary btn-large"
                (click)="enrollStudentsInModule()"
                [disabled]="!canEnrollInModule() || isLoadingEnrollmentData()"
              >
                <mat-icon fontIcon="person_add"></mat-icon>
                Enroll {{ getSelectedStudentIds().length }} Student(s) in Module
              </button>
            </div>
          </div>
        }

        @if (currentView() === 'audit') {
          <div class="view-container">
            <div class="view-header">
              <h2>Audit Log</h2>
              <button class="action-btn-toolbar action-btn-toolbar--secondary"
                      (click)="clearAuditFilters()" title="Clear all filters">
                <mat-icon fontIcon="filter_alt_off"></mat-icon>
                <span>Clear Filters</span>
              </button>
            </div>

            <!-- Filter Section -->
            <div class="audit-filters">
              <div class="filter-row">
                <div class="filter-group">
                  <label for="filter-user">User ID</label>
                  <input
                    type="text"
                    id="filter-user"
                    class="filter-input"
                    placeholder="Filter by user..."
                    [value]="auditFilters().actorUserId"
                    (input)="updateAuditFilter('actorUserId', $any($event.target).value)"
                  />
                </div>

                <div class="filter-group">
                  <label for="filter-entity-type">Entity Type</label>
                  <select
                    id="filter-entity-type"
                    class="filter-select"
                    [value]="auditFilters().entityType"
                    (change)="updateAuditFilter('entityType', $any($event.target).value)"
                  >
                    <option value="">All Types</option>
                    <option value="User">User</option>
                    <option value="Course">Course</option>
                    <option value="Module">Module</option>
                    <option value="Enrollment">Enrollment</option>
                    <option value="Student">Student</option>
                  </select>
                </div>

                <div class="filter-group">
                  <label for="filter-entity-id">Entity ID</label>
                  <input
                    type="text"
                    id="filter-entity-id"
                    class="filter-input"
                    placeholder="Filter by entity ID..."
                    [value]="auditFilters().entityId"
                    (input)="updateAuditFilter('entityId', $any($event.target).value)"
                  />
                </div>

                <div class="filter-group">
                  <label for="filter-action">Action</label>
                  <input
                    type="text"
                    id="filter-action"
                    class="filter-input"
                    placeholder="Filter by action..."
                    [value]="auditFilters().action"
                    (input)="updateAuditFilter('action', $any($event.target).value)"
                  />
                </div>
              </div>

              <div class="filter-row">
                <div class="filter-group">
                  <label for="filter-from">From Date</label>
                  <input
                    type="datetime-local"
                    id="filter-from"
                    class="filter-input"
                    [value]="auditFilters().fromUtc"
                    (input)="updateAuditFilter('fromUtc', $any($event.target).value)"
                  />
                </div>

                <div class="filter-group">
                  <label for="filter-to">To Date</label>
                  <input
                    type="datetime-local"
                    id="filter-to"
                    class="filter-input"
                    [value]="auditFilters().toUtc"
                    (input)="updateAuditFilter('toUtc', $any($event.target).value)"
                  />
                </div>

                <div class="filter-group filter-group--actions">
                  <button class="btn-primary" (click)="applyAuditFilters()">
                    <mat-icon fontIcon="search"></mat-icon>
                    Apply Filters
                  </button>
                </div>
              </div>
            </div>

            <!-- Audit Events List -->
            @if (isLoading()) {
              <div class="section-loading">
                <mat-icon fontIcon="refresh" class="spinning"></mat-icon>
                <p>Loading audit events...</p>
              </div>
            } @else {
              <div class="audit-events-container">
                @for (event of auditEvents(); track event.id) {
                  <div class="audit-event" (click)="viewAuditEventDetails(event.id!)">
                    <div class="audit-event-icon" [class]="getActionColor(event.action)">
                      <mat-icon [fontIcon]="getActionIcon(event.action)"></mat-icon>
                    </div>
                    <div class="audit-event-content">
                      <div class="audit-event-header">
                        <span class="audit-event-action">{{ event.action || 'Unknown Action' }}</span>
                        <span class="audit-event-time">{{ formatAuditDate(event.occurredAtUtc) }}</span>
                      </div>
                      <div class="audit-event-summary">{{ event.summary || 'No summary available' }}</div>
                      <div class="audit-event-meta">
                        @if (event.entityType) {
                          <span class="audit-meta-tag">
                            <mat-icon fontIcon="label"></mat-icon>
                            {{ event.entityType }}
                          </span>
                        }
                        @if (event.actorUserId) {
                          <span class="audit-meta-tag">
                            <mat-icon fontIcon="person"></mat-icon>
                            {{ event.actorUserId.substring(0, 8) }}...
                          </span>
                        }
                      </div>
                    </div>
                  </div>
                } @empty {
                  <div class="empty-state">
                    <mat-icon fontIcon="history"></mat-icon>
                    <p>No audit events found</p>
                    <small>Try adjusting your filters</small>
                  </div>
                }
              </div>
            }
          </div>
        }
      }
    </main>
  </div>

  @if (showUserDetails()) {
    <div class="modal-overlay" (click)="closeUserDetails()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>User Details</h3>
          <button class="modal-close" (click)="closeUserDetails()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          @for (user of users(); track user.id) {
            @if (user.id === showUserDetails()) {
              <div class="detail-row">
                <span class="detail-label">User Id:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ user.id }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(user.id, 'User Id')"
                          title="Copy User ID">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">First Name:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ user.firstName || 'N/A' }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(user.firstName, 'First Name')"
                          title="Copy First Name">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Last Name:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ user.lastName || 'N/A' }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(user.lastName, 'Last Name')"
                          title="Copy Last Name">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Email:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ user.email }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(user.email, 'Email')"
                          title="Copy Email">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Roles:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ getRoleName(user.roles) }}</span>
                  <button class="copy-btn"
                          (click)="copyToClipboard(getRoleName(user.roles), 'Roles')"
                          title="Copy Roles">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value">
                  <span class="status" [class.status--active]="user.isActive"
                        [class.status--inactive]="!user.isActive">
                    {{ user.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Permissions:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ user.permissions }}</span>
                  <button class="copy-btn"
                          (click)="copyToClipboard(user.permissions?.toString(), 'Permissions')"
                          title="Copy Permissions">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn-secondary" (click)="impersonateUser(user.id!)">
                  <mat-icon fontIcon="person"></mat-icon>
                  Impersonate User
                </button>
                <button class="btn-warning" (click)="assignRole(user.id!, 1)">
                  <mat-icon fontIcon="admin_panel_settings"></mat-icon>
                  Assign Role
                </button>
              </div>
            }
          }
        </div>
      </div>
    </div>
  }

  @if (contextMenuUserId() && contextMenuPosition(); as pos) {
    <div class="context-menu" [style.left.px]="pos.x" [style.top.px]="pos.y"
         (click)="$event.stopPropagation()">
      <button class="context-menu-item" (click)="handleViewDetails()">
        <mat-icon fontIcon="visibility"></mat-icon>
        <span>View Details</span>
      </button>
      <button class="context-menu-item" (click)="handleEditUser()">
        <mat-icon fontIcon="edit"></mat-icon>
        <span>Edit User</span>
      </button>
      <button class="context-menu-item" (click)="handleResetPassword()">
        <mat-icon fontIcon="lock_reset"></mat-icon>
        <span>Reset Password</span>
      </button>
      <button class="context-menu-item" (click)="handleToggleStatus()">
        <mat-icon [fontIcon]="getContextMenuUser()?.isActive ? 'block' : 'check_circle'"></mat-icon>
        <span>{{ getContextMenuUser()?.isActive ? 'Deactivate' : 'Activate' }}</span>
      </button>
      <div class="context-menu-divider"></div>
      <button class="context-menu-item" (click)="handleAssignRole()">
        <mat-icon fontIcon="admin_panel_settings"></mat-icon>
        <span>Assign Role</span>
      </button>
      <button class="context-menu-item" (click)="handleImpersonate()">
        <mat-icon fontIcon="person"></mat-icon>
        <span>Impersonate User</span>
      </button>
      <div class="context-menu-divider"></div>
      <button class="context-menu-item context-menu-item--danger" (click)="handleDeleteUser()">
        <mat-icon fontIcon="delete"></mat-icon>
        <span>Delete User</span>
      </button>
    </div>
  }

  @if (contextMenuCourseId() && contextMenuPosition(); as pos) {
    <div class="context-menu" [style.left.px]="pos.x" [style.top.px]="pos.y"
         (click)="$event.stopPropagation()">
      <button class="context-menu-item" (click)="handleViewCourse()">
        <mat-icon fontIcon="visibility"></mat-icon>
        <span>View Details</span>
      </button>
      <button class="context-menu-item" (click)="handleEditCourse()">
        <mat-icon fontIcon="edit"></mat-icon>
        <span>Edit Course</span>
      </button>
      <button class="context-menu-item" (click)="handleCloneCourse()">
        <mat-icon fontIcon="content_copy"></mat-icon>
        <span>Clone Course</span>
      </button>
      <div class="context-menu-divider"></div>
      <button class="context-menu-item context-menu-item--danger" (click)="handleDeleteCourse()">
        <mat-icon fontIcon="delete"></mat-icon>
        <span>Delete Course</span>
      </button>
    </div>
  }

  @if (contextMenuModuleId() && contextMenuPosition(); as pos) {
    <div class="context-menu" [style.left.px]="pos.x" [style.top.px]="pos.y"
         (click)="$event.stopPropagation()">
      <button class="context-menu-item" (click)="handleViewModule()">
        <mat-icon fontIcon="visibility"></mat-icon>
        <span>View Details</span>
      </button>
      <button class="context-menu-item" (click)="handleEditModule()">
        <mat-icon fontIcon="edit"></mat-icon>
        <span>Edit Module</span>
      </button>
      <button class="context-menu-item" (click)="handleCloneModule()">
        <mat-icon fontIcon="content_copy"></mat-icon>
        <span>Clone Module</span>
      </button>
      <div class="context-menu-divider"></div>
      <button class="context-menu-item context-menu-item--danger" (click)="handleDeleteModule()">
        <mat-icon fontIcon="delete"></mat-icon>
        <span>Delete Module</span>
      </button>
    </div>
  }

  @if (showCreateUserModal()) {
    <div class="modal-overlay" (click)="closeCreateUserModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Create New User</h3>
          <button class="modal-close" (click)="closeCreateUserModal()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="create-firstName">First Name</label>
            <input type="text" id="create-firstName" class="form-control"
                   placeholder="Enter first name" [(ngModel)]="newUser().firstName">
          </div>
          <div class="form-group">
            <label for="create-lastName">Last Name</label>
            <input type="text" id="create-lastName" class="form-control"
                   placeholder="Enter last name" [(ngModel)]="newUser().lastName">
          </div>
          <div class="form-group">
            <label for="create-email">Email</label>
            <input type="email" id="create-email" class="form-control" placeholder="Enter email"
                   [(ngModel)]="newUser().email">
          </div>
          <div class="form-group">
            <label for="create-password">Password</label>
            <input type="password" id="create-password" class="form-control"
                   placeholder="Enter password" [(ngModel)]="newUser().password">
          </div>
          <div class="form-group">
            <label for="create-role">Role</label>
            <select id="create-role" class="form-control" [(ngModel)]="newUser().systemRole">
              <option [ngValue]="null">-- No Role --</option>
              <option [ngValue]="1">Student</option>
              <option [ngValue]="2">Staff</option>
              <option [ngValue]="3">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="newUser().isActive">
              <span>Active</span>
            </label>
          </div>

          <div class="modal-actions">
            <button class="btn-secondary" (click)="closeCreateUserModal()">
              Cancel
            </button>
            <button class="btn-primary" (click)="createUser()">
              <mat-icon fontIcon="add"></mat-icon>
              Create User
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (showCreateCourseModal()) {
    <div class="modal-overlay" (click)="closeCreateCourseModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Create New Course</h3>
          <button class="modal-close" (click)="closeCreateCourseModal()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="create-course-code">Course Code *</label>
            <input type="text" id="create-course-code" class="form-control"
                   placeholder="e.g., CS101" [(ngModel)]="newCourse().code">
          </div>
          <div class="form-group">
            <label for="create-course-title">Title *</label>
            <input type="text" id="create-course-title" class="form-control"
                   placeholder="Enter course title" [(ngModel)]="newCourse().title">
          </div>
          <div class="form-group">
            <label for="create-course-description">Description</label>
            <textarea id="create-course-description" class="form-control" rows="3"
                      placeholder="Enter course description"
                      [(ngModel)]="newCourse().description"></textarea>
          </div>
          <div class="form-group">
            <label for="create-course-award">Award</label>
            <input type="text" id="create-course-award" class="form-control"
                   placeholder="e.g., BSc Computer Science" [(ngModel)]="newCourse().award">
          </div>
          <div class="form-group">
            <label for="create-course-duration">Duration (Semesters)</label>
            <input type="number" id="create-course-duration" class="form-control" min="0"
                   placeholder="e.g., 6" [(ngModel)]="newCourse().durationSemesters">
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="newCourse().isActive">
              <span>Active</span>
            </label>
          </div>

          <div class="modal-actions">
            <button class="btn-secondary" (click)="closeCreateCourseModal()">
              Cancel
            </button>
            <button class="btn-primary" (click)="createCourse()">
              <mat-icon fontIcon="add"></mat-icon>
              Create Course
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (showCreateModuleModal()) {
    <div class="modal-overlay" (click)="closeCreateModuleModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Create New Module</h3>
          <button class="modal-close" (click)="closeCreateModuleModal()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="create-module-code">Module Code *</label>
            <input type="text" id="create-module-code" class="form-control"
                   placeholder="e.g., CS201" [(ngModel)]="newModule().code">
          </div>
          <div class="form-group">
            <label for="create-module-title">Title *</label>
            <input type="text" id="create-module-title" class="form-control"
                   placeholder="Enter module title" [(ngModel)]="newModule().title">
          </div>
          <div class="form-group">
            <label for="create-module-description">Description</label>
            <textarea id="create-module-description" class="form-control" rows="3"
                      placeholder="Enter module description"
                      [(ngModel)]="newModule().description"></textarea>
          </div>
          <div class="form-group">
            <label for="create-module-credits">Credits</label>
            <input type="number" id="create-module-credits" class="form-control" min="0"
                   placeholder="e.g., 15" [(ngModel)]="newModule().credits">
          </div>
          <div class="form-group">
            <label for="create-module-level">Level</label>
            <input type="number" id="create-module-level" class="form-control" min="0"
                   placeholder="e.g., 4" [(ngModel)]="newModule().level">
          </div>
          <div class="form-group">
            <label for="create-module-semester">Semester of Study</label>
            <input type="number" id="create-module-semester" class="form-control" min="1"
                   placeholder="e.g., 1" [(ngModel)]="newModule().semesterOfStudy">
          </div>
          <div class="form-group">
            <label for="create-module-term">Term</label>
            <input type="text" id="create-module-term" class="form-control"
                   placeholder="e.g., Autumn" [(ngModel)]="newModule().term">
          </div>

          <div class="modal-actions">
            <button class="btn-secondary" (click)="closeCreateModuleModal()">
              Cancel
            </button>
            <button class="btn-primary" (click)="createModule()">
              <mat-icon fontIcon="add"></mat-icon>
              Create Module
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (showCourseDetails()) {
    <div class="modal-overlay" (click)="closeCourseDetails()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Course Details</h3>
          <button class="modal-close" (click)="closeCourseDetails()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          @for (course of courses(); track course.id) {
            @if (course.id === showCourseDetails()) {
              <div class="detail-row">
                <span class="detail-label">Course Id:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ course.id }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(course.id, 'Course Id')"
                          title="Copy Course Id">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Course Code:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ course.courseCode }}</span>
                  <button class="copy-btn"
                          (click)="copyToClipboard(course.courseCode, 'Course Code')"
                          title="Copy Course Code">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Title:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ course.title }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(course.title, 'Title')"
                          title="Copy Title">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
            }
          }
        </div>
      </div>
    </div>
  }

  @if (showEditCourseModal()) {
    <div class="modal-overlay" (click)="closeEditCourseModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Edit Course</h3>
          <button class="modal-close" (click)="closeEditCourseModal()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="edit-course-code">Course Code *</label>
            <input type="text" id="edit-course-code" class="form-control"
                   [(ngModel)]="editCourseData().code">
          </div>
          <div class="form-group">
            <label for="edit-course-title">Title *</label>
            <input type="text" id="edit-course-title" class="form-control"
                   [(ngModel)]="editCourseData().title">
          </div>
          <div class="form-group">
            <label for="edit-course-description">Description</label>
            <textarea id="edit-course-description" class="form-control" rows="3"
                      [(ngModel)]="editCourseData().description"></textarea>
          </div>
          <div class="form-group">
            <label for="edit-course-award">Award</label>
            <input type="text" id="edit-course-award" class="form-control"
                   [(ngModel)]="editCourseData().award">
          </div>
          <div class="form-group">
            <label for="edit-course-duration">Duration (Semesters)</label>
            <input type="number" id="edit-course-duration" class="form-control" min="0"
                   [(ngModel)]="editCourseData().durationSemesters">
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="editCourseData().isActive">
              <span>Active</span>
            </label>
          </div>

          <div class="modal-actions">
            <button class="btn-secondary" (click)="closeEditCourseModal()">
              Cancel
            </button>
            <button class="btn-primary" (click)="updateCourse()">
              <mat-icon fontIcon="save"></mat-icon>
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (showModuleDetails()) {
    <div class="modal-overlay" (click)="closeModuleDetails()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Module Details</h3>
          <button class="modal-close" (click)="closeModuleDetails()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          @for (module of modules(); track module.id) {
            @if (module.id === showModuleDetails()) {
              <div class="detail-row">
                <span class="detail-label">Module Id:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ module.id }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(module.id, 'Module Id')"
                          title="Copy Module Id">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Module Code:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ module.moduleCode }}</span>
                  <button class="copy-btn"
                          (click)="copyToClipboard(module.moduleCode, 'Module Code')"
                          title="Copy Module Code">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Title:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ module.title }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(module.title, 'Title')"
                          title="Copy Title">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Course Id:</span>
                <div class="detail-value-group">
                  <span class="detail-value">{{ module.courseId }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(module.courseId, 'Course ID')"
                          title="Copy Course ID">
                    <mat-icon fontIcon="content_copy"></mat-icon>
                  </button>
                </div>
              </div>
            }
          }
        </div>
      </div>
    </div>
  }

  @if (showEditModuleModal()) {
    <div class="modal-overlay" (click)="closeEditModuleModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Edit Module</h3>
          <button class="modal-close" (click)="closeEditModuleModal()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="edit-module-code">Module Code *</label>
            <input type="text" id="edit-module-code" class="form-control"
                   [(ngModel)]="editModuleData().code">
          </div>
          <div class="form-group">
            <label for="edit-module-title">Title *</label>
            <input type="text" id="edit-module-title" class="form-control"
                   [(ngModel)]="editModuleData().title">
          </div>
          <div class="form-group">
            <label for="edit-module-description">Description</label>
            <textarea id="edit-module-description" class="form-control" rows="3"
                      [(ngModel)]="editModuleData().description"></textarea>
          </div>
          <div class="form-group">
            <label for="edit-module-credits">Credits</label>
            <input type="number" id="edit-module-credits" class="form-control" min="0"
                   [(ngModel)]="editModuleData().credits">
          </div>
          <div class="form-group">
            <label for="edit-module-level">Level</label>
            <input type="number" id="edit-module-level" class="form-control" min="0"
                   [(ngModel)]="editModuleData().level">
          </div>
          <div class="form-group">
            <label for="edit-module-semester">Semester of Study</label>
            <input type="number" id="edit-module-semester" class="form-control" min="1"
                   [(ngModel)]="editModuleData().semesterOfStudy">
          </div>
          <div class="form-group">
            <label for="edit-module-term">Term</label>
            <input type="text" id="edit-module-term" class="form-control"
                   [(ngModel)]="editModuleData().term">
          </div>

          <div class="modal-actions">
            <button class="btn-secondary" (click)="closeEditModuleModal()">
              Cancel
            </button>
            <button class="btn-primary" (click)="updateModule()">
              <mat-icon fontIcon="save"></mat-icon>
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (showEnrollmentDetails()) {
    <app-enrollment-details
      [mode]="enrollmentDetailsMode()"
      [entityId]="enrollmentDetailsEntityId()"
      [entityName]="enrollmentDetailsEntityName()"
      (close)="closeEnrollmentDetails()"
      (enrollStudents)="handleEnrollStudents($event)"
      (cancelEnrollment)="handleCancelEnrollment($event)"
    ></app-enrollment-details>
  }

  @if (showAuditEventDetails()) {
    <div class="modal-overlay" (click)="closeAuditEventDetails()">
      <div class="modal-content modal-content--large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Audit Event Details</h3>
          <button class="modal-close" (click)="closeAuditEventDetails()">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="modal-body">
          @for (event of auditEvents(); track event.id) {
            @if (event.id === showAuditEventDetails()) {
              <div class="audit-details">
                <div class="detail-section">
                  <h4>Event Information</h4>
                  <div class="detail-grid">
                    <div class="detail-item">
                      <label>Event ID</label>
                      <span class="detail-value">{{ event.id }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Occurred At</label>
                      <span class="detail-value">{{ event.occurredAtUtc | date:'medium' }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Action</label>
                      <span class="detail-badge" [class]="getActionColor(event.action)">
                        <mat-icon [fontIcon]="getActionIcon(event.action)"></mat-icon>
                        {{ event.action }}
                      </span>
                    </div>
                    <div class="detail-item">
                      <label>Actor</label>
                      <span class="detail-value">{{ event.actorUserId || 'System' }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Entity Type</label>
                      <span class="detail-value">{{ event.entityType || 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Entity ID</label>
                      <span class="detail-value">{{ event.entityId || 'N/A' }}</span>
                    </div>
                  </div>
                </div>

                <div class="detail-section">
                  <h4>Summary</h4>
                  <p class="summary-text">{{ event.summary || 'No summary available' }}</p>
                </div>

                @if (hasChanges(event.changesJson)) {
                  <div class="detail-section">
                    <h4>Changes</h4>
                    <div class="changes-container">
                      @for (field of Object.keys(parseChangesJson(event.changesJson).Fields || {}); track field) {
                        @let change = parseChangesJson(event.changesJson).Fields[field];
                        <div class="change-item">
                          <div class="change-field">
                            <mat-icon fontIcon="label"></mat-icon>
                            <span>{{ field }}</span>
                          </div>
                          <div class="change-values">
                            <div class="change-old">
                              <label>Old Value</label>
                              <div class="value-box value-box--old">
                                {{ change.Old !== null ? change.Old : 'null' }}
                              </div>
                            </div>
                            <div class="change-arrow">
                              <mat-icon fontIcon="arrow_forward"></mat-icon>
                            </div>
                            <div class="change-new">
                              <label>New Value</label>
                              <div class="value-box value-box--new">
                                {{ change.New !== null ? change.New : 'null' }}
                              </div>
                            </div>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }

                @if (event.changesJson && !hasChanges(event.changesJson)) {
                  <div class="detail-section">
                    <h4>Changes (Raw)</h4>
                    <pre class="detail-json">{{ event.changesJson }}</pre>
                  </div>
                }

                @if (event.metadataJson) {
                  <div class="detail-section">
                    <h4>Metadata</h4>
                    <pre class="detail-json">{{ event.metadataJson }}</pre>
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>
    </div>
  }

</div>
